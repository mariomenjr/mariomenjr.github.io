[{"author":"Mario Menj√≠var","slug":"como-crear-un-blog-a-base-de-markdown-y-javascript","title":"C√≥mo crear un blog a base de markdown y javascript","timestamp":"2020-08-09T10:23:17.000-07:00","brief":"Seguramente te haz hecho la siguiente pregunta: ¬øC√≥mo hostear un blog que sea f√°cil de mantener, sin pagar un centavo? En este post te explico una de tantas alternativas.","keywords":"javascript,svelte,blog,markdown,howto","endpoint":"2020/08/09/como-crear-un-blog-a-base-de-markdown-y-javascript","content":"\n# C√≥mo crear un blog a base de markdown y JavaScript\n\nSeguramente te haz hecho la siguiente pregunta: ¬øC√≥mo hostear un blog que sea f√°cil de mantener, sin pagar un centavo? En este post te explico una de tantas alternativas.\n\n## Porqu√©\n\nOtra pregunta que probablemente este en tu cabeza es ¬øPor qu√© markdown y JavaScript? La respuesta es un poco m√°s elaborada. Para empezar, ¬øQu√© es markdown? Seg√∫n Wikipedia: \n\n> \"Markdown es un lenguaje de marcado ligero que trata de conseguir la m√°xima legibilidad y facilidad de publicaci√≥n tanto en su forma de entrada como de salida, inspir√°ndose en muchas convenciones existentes para marcar mensajes de correo electr√≥nico usando texto plano\" de [Wikipedia](https://es.wikipedia.org/wiki/Markdown).\n\nAl usar markdown para escribir un post, estamos estructurando nuestro contenido sin necesidad de incluir HTML o CSS en el momento. Es decir, nos enfocamos enteramente en lo importante: el texto. Esta simplicidad se ver√° potencializada al incluir _Git_ y _Github_ en la formula, ya que podremos versionar nuestro contenido.\n\nComo mencion√©, hay muchas alternativas para lograrlo. Fundamentalmente una p√°gina web no es m√°s que HTML, CSS y JavaScript. Herramientas como [_Jekyll_](https://jekyllrb.com/), aprovechan esta regla de oro para ayudarte a generar y administrar posts f√°cilmente haciendo uso de markdown. Pero, ¬øQu√© pasa si queremos tomar ventaja de todas las herramientas disponibles en el ecosistema JavaScript que se han establecido en los √∫ltimos 10 a√±os?  Para eso tenemos [_Gatsby_](https://www.gatsbyjs.org/), [_Next.js_](https://nextjs.org/) o [_Sapper_](https://sapper.svelte.dev/docs).\n\n_In a nutshell_, estos tres frameworks permiten generar sitios est√°ticos haciendo uso de herramientas modernas como React o Svelte. En este post nos centraremos en _Sapper_.\n\n## ¬øPor qu√© _Sapper_?\n\nSvelte es el nuevo chico de la cuadra. Su propuesta insignia es mover la reactividad de la UI desde mediadores como el Virtual DOM hacia el lenguaje, o mejor dicho, al compilador, en contraste con React o Vue. Esto aumenta el desempe√±o de las aplicaciones y disminuye el tama√±o del _bundle_.\n\nPuedes echar un vistazo a la [comparativa](https://www.swyx.io/writing/svelte-static/) entre Gatsby y Sapper realizada por [Shawn Wang](https://twitter.com/swyx), un popular desarrollador en [egghead.io](https://egghead.io/). Se muestra una reducci√≥n del 93% en el tama√±o del _bundle_ con _Sapper_.\n\n## Setup\n\nPara instalar Sapper, basta con ejecutar los siguientes comandos:\n\n```bash\n[user@host ~]$ npx degit \"sveltejs/sapper-template#rollup\" my-blog\n[user@host ~]$ cd my-blog\n[user@host my-blog]$ npm install\n[user@host my-blog]$ npm run dev\n```\n\nEn el folder del projecto _my-blog_, nos interesan los siguientes files:\n\n```text\n...\n‚îú src\n‚îÇ ‚îú routes\n| | ‚îú blog\n| | | ‚îú _posts.js\n| | | ‚îú [slug].json.js\n| | | ‚îú [slug].svelte\n| | | ‚îú index.json.js\n| | | ‚îú index.svelte\n...\n```\n\nDe paso creamos el siguiente directorio y archivo:\n\n```text\n...\n+ ‚îú content\n+ ‚îÇ ‚îú 2020-08-08_hola-mundo.md\n  ‚îú src\n  ‚îÇ ‚îú routes\n...\n```\n\nCon el siguiente contenido:\n\n```text\n---\nauthor: 'Mario Menj√≠var'\nslug: 'hola-mundo'\ntitle: 'Hola Mundo'\ntimestamp: '2020-08-08T10:23:17.000-07:00'\n---\n\n# Hola mundo\n\nHola mundo.\n```\n\nNecesitamos instalar los siguientes paquetes:\n\n```bash\n[user@host my-blog]$ npm i gray-matter highlight.js marked\n```\n\nEn mi caso, quiero que los posts est√©n ordenados por su fecha de publicaci√≥n y que esto se refleje en la URL. Tendremos que hacer unos cambios a los siguientes archivos:\n\n```text\n...\n- | | | ‚îú [slug].json.js\n- | | | ‚îú [slug].svelte\n+ | | | ‚îú [...slug].json.js\n+ | | | ‚îú [...slug].svelte\n...\n```\n\nLuego, reemplazamos el contenido:\n\n```javascript\n// src/routes/blog/[...slug].json.js\n\nimport fs from \"fs\";\nimport path from \"path\";\nimport marked from \"marked\";\nimport hljs from \"highlight.js\";\nimport grayMatter from \"gray-matter\";\n\n/*\n * Para obtener el contenido del post\n */\nfunction getPost(year, month, day, fileName) {\n  return fs.readFileSync(\n    path.resolve(\"content\", `${year}-${month}-${day}_${fileName}.md`),\n    \"utf-8\"\n  );\n}\n\n/*\n * En Sapper, este m√©todo responde a una request a trav√©s del m√©todo GET\n * En nuestro caso, la request de un JSON\n */\nexport function get(req, res, next) {\n  // As√≠ es c√≥mo resolvemos una `dynamic route` en Sapper,\n  // obtenemos cada valor en su variable respectiva\n  let [year, month, day, slug] = req.params.slug;\n\n  const postMarkdown = getPost(year, month, day, slug);\n  const renderer = new marked.Renderer();\n\n  // marked provee una manera de formatear partes espec√≠ficas del markdown\n  // en este caso, el c√≥digo\n  renderer.code = (source, lang) => {\n    const { value: highlighted } = hljs.highlight(lang, source);\n    return `<pre class='language-${lang} overflow-x-auto'><code>${highlighted}</code></pre>`;\n  };\n\n  marked.use({ renderer });\n\n  const { data, content } = grayMatter(postMarkdown);\n  const html = marked(content);\n\n  if (html) {\n    res.writeHead(200, { \"Content-Type\": \"application/json\" });\n    res.end(JSON.stringify({ html, ...data }));\n  } else {\n    res.writeHead(404, { \"Content-Type\": \"application/json\" });\n    res.end(JSON.stringify({ message: `Not found` }));\n  }\n}\n```\n```html\n<!-- src/routes/blog/[...slug].svelte -->\n\n<script context=\"module\">\n  /*\n   * Este m√©todo representa un paso en el ciclo de vida de un component en Sapper.\n   *\n   * √önicamente se ejecuta cuando el componente es montado. Aqu√≠ haremos la petici√≥n de nuestro JSON con la informaci√≥n del post\n   */\n  export async function preload({ params }) {\n    let [year, month, day, slug] = params.slug;\n\n    const res = await this.fetch(`blog/${year}/${month}/${day}/${slug}.json`);\n    const data = await res.json();\n\n    if (res.status === 200) {\n      return { post: data };\n    } else {\n      this.error(res.status, data.message);\n    }\n  }\n</script>\n\n<script>\n  export let post;\n</script>\n\n<svelte:head>\n  <title>{post.title} by {post.author}</title>\n</svelte:head>\n\n<article>\n  {@html post.html}\n</article>\n```\n\nDe esta forma se renderizar√° el post. Ya puedes verlo en tu ambiente local yendo a [/blog/2020/08/08/hola-mundo](http://localhost:3000/blog/2020/08/08/hola-mundo).\n\nA√∫n hay un peque√±o detalle que debemos cubrir para cumplir con las reglas que _Sapper_ establece si queremos exportar nuestro peque√±o blog como un sitio est√°tico.\n\n> \"... cualquier p√°gina que quieras que sea inclu√≠da en el sitio (est√°tico) exportado debe ser esta ligado con una etiqueta del tipo \\<a\\> o a√±adida c√≥mo parametro de la opci√≥n  --entry del comando `sapper export`\" de [Sapper docs](https://sapper.svelte.dev/docs#How_it_works).\n\nDe acuerdo a la documentaci√≥n, debemos incluir elementos **\\<a\\>** que apunten a nuestras p√°ginas generadas a partir de rutas din√°micas, para que al exportar el sitio estas tambi√©n se incluyan. Por eso programaremos el endpoint [/blog](http://localhost:3000/blog).\n\n```javascript\n// src/routes/blog/index.json.js\n\nimport fs from \"fs\";\nimport path from \"path\";\nimport grayMatter from \"gray-matter\";\n\nfunction getAllPosts() {\n  const posts = fs\n    .readdirSync(\"content\")\n    .map((fileName) => {\n      const post = fs.readFileSync(path.resolve(\"content\", fileName), \"utf-8\");\n      return grayMatter(post).data;\n    })\n    .sort((a, b) => {\n      if (b.timestamp < a.timestamp) return -1;\n      if (b.timestamp > a.timestamp) return 1;\n\n      return 0;\n    });\n  return posts;\n}\n\nexport function get(req, res) {\n  res.writeHead(200, { \"Content-Type\": \"application/json\" });\n  res.end(JSON.stringify(getAllPosts()));\n}\n```\n```html\n<!-- src/routes/blog/index.svelte -->\n\n<script context=\"module\">\n  export function preload({ params, query }) {\n    return this.fetch(`blog.json`)\n      .then((r) => r.json())\n      .then((posts) => ({\n        posts: posts.map((post) => {\n          const timestamp = new Date(post.timestamp);\n          return {\n            ...post,\n            timestamp,\n            date: {\n              year: timestamp.getFullYear(),\n              month: `${timestamp.getMonth() + 1}`.padStart(2, `0`),\n              day: `${timestamp.getDate()}`.padStart(2, `0`),\n            },\n          };\n        }),\n      }));\n  }\n</script>\n\n<script>\n  export let posts;\n</script>\n\n<svelte:head>\n  <title>Blog | Mario Menj√≠var</title>\n</svelte:head>\n\n<ul>\n  {#each posts as post}\n  <li>\n    <a\n      rel=\"prefetch\"\n      href=\"blog/{post.date.year}/{post.date.month}/{post.date.day}/{post.slug}\"\n    >\n      {post.title}\n    </a>\n    <p class=\"c-label-last-updated\">\n      Posted on {post.timestamp.toLocaleString()} by {post.author}\n    </p>\n  </li>\n  {/each}\n</ul>\n```\n\nListo.\n\n## Sitio est√°tico\n\nAntes de desplegar nuestro fant√°stico blog, necesitamos asegurarnos que las p√°ginas est√°ticas se generaran sin problemas. Para eso necesitamos ejecutar lo siguiente en la l√≠nea de comandos:\n\n```bash\n[user@host my-blog]$ npm run export\n[user@host my-blog]$ npx serve __sapper__/export\n```\n\nSi no tienes ningun problema al acceder a este endpoint [/blog/2020/08/08/hola-mundo](http://localhost:5000/blog/2020/08/08/hola-mundo), ¬°Felicidades! solo nos queda desplegar el sitio.\n\n\n## Despliegue: Github Pages\n\nNuestro sitio est√°tico ha sido generado y los archivos est√°n dentro de la carpeta `__sapper__/export`. Existen una infinidad de servicios que te permiten almacenar y servir este tipo de sitios, entre los m√°s populares tenemos Netlify o Github Pages. En este post te mostrar√© c√≥mo hacerlo con _Github Pages_.\n\nPodr√≠amos subir el folder `__sapper__/export` a un nuevo repositorio, activar la opci√≥n _Github Pages_ y repetir este proceso manualmente cada vez que actualicemos nuestro sitio con un nuevo post. En mi opini√≥n, hacerlo de manera manual le quita la diversi√≥n. Afortunadamente, exite _Github Actions_.\n\nEl primer paso es crear dos repositorios en _Github_, el primero es el repositorio de nuestro projecto y el segundo el repositorio al cu√°l subiremos nuestro sitio est√°tico. En mi caso, [mariomenjr/mariomenjr](https://github.com/mariomenjr/mariomenjr) y [mariomenjr/mariomenjr.github.io](https://github.com/mariomenjr/mariomenjr.github.io) respectivamente. Una vez hecho esto, creamos los siguientes folders y archivos en el folder del projecto:\n\n```text\n...\n‚îú .github\n‚îÇ ‚îú workflows\n| | | deploy.yml\n‚îú src\n...\n```\n```yml\n# .github/workflows/deploy.yml\n\nname: Build and deploy\non:\n    push:\n      branches: \n        # √önicamente cuando actualicemos master\n        - master\njobs:\n  build-and-deploy:\n    runs-on: ubuntu-latest\n    steps:\n      - name: Checkout üõéÔ∏è\n        uses: actions/checkout@v2.3.1\n        with:\n          persist-credentials: false\n      - name: Install and build\n        run: |\n          npm install\n          npm run export\n      - name: Deploy üöÄ\n        uses: JamesIves/github-pages-deploy-action@3.5.9\n        with:\n          # Limpiar√° el despliegue previo\n          CLEAN: true\n          # Necesitamos crear este secret para el repositorio\n          GITHUB_TOKEN: ${{ secrets.DEPLOY_MARIOMENJR }}\n          BRANCH: master\n          FOLDER: __sapper__/export\n          BASE_BRANCH: master\n          REPOSITORY_NAME: mariomenjr/mariomenjr.github.io\n\n```\n\nEl archivo anterior se explica en la [documentaci√≥n](https://github.com/marketplace/actions/deploy-to-github-pages) de la acci√≥n. En este post nos centraremos en un l√≠nea 1 l√≠nea: \n\n```yml\n...\njobs:\n  build-and-deploy:\n    ...\n    steps:\n      ...\n      - name: Deploy üöÄ\n        ...\n        with:\n          ...\n          # Necesitamos crear este secret para el repositorio\n          GITHUB_TOKEN: ${{ secrets.DEPLOY_MARIOMENJR }}\n          ...\n```\n\nEs esta l√≠nea la que autoriza a la acci√≥n a hacer cambios al repositorio `mariomenjr/mariomenjr.github.io`.\n\nPara generar tu _Github token_, dir√≠gete a [github.com/settings/tokens](https://github.com/settings/tokens), haz clic en el bot√≥n `Generate new token`, escribe un nombre significativo en el campo `Note`, selecciona el _checkbox_ **_repo_** y, por √∫ltimo, haz clic en el bot√≥n `Generate token`.\n\n![Github personal access tokens](https://imgur.com/HbbMgm7.png)\n\nNo olvides copiar el token.\n\nPor √∫ltimo, dir√≠gete al repositorio del projecto para crear la variable de entorno que incluir√°s en el archivo `deploy.yml`.\n\n![Add secret to repository](https://imgur.com/iuyGLdc.png)\n\n```yml\n...\njobs:\n  build-and-deploy:\n    ...\n    steps:\n      ...\n      - name: Deploy üöÄ\n        ...\n        with:\n          ...\n          # Necesitamos crear este secret para el repositorio\n          GITHUB_TOKEN: ${{ secrets.MI_VARIABLE }}\n          ...\n```\n\nListo. Tan pronto hagas push al repositorio del projecto, _Github Actions_ desplegar√° tu sitio est√°tico.\n\n![Github Action Deployment](https://imgur.com/fHxzGuf.png)\n\n# Conclusi√≥n\n\nPuedes usar WordPress, Ghosts, incluso Jekyll si lo prefieres. El objetivo de este post es mostrarte como todas esas herramientas tienen su origen en cosas b√°sicas que con el tiempo se convierten en herramientas robustas listas para sacarles provecho.\n\nMe decid√≠ a construir este blog, de esta manera, para poner en pr√°ctica el concepto [Aprender en P√∫blico](https://ricardoerl.com/blog/aprender-en-publico) que present√≥ [Ricardo](https://ricardoerl.com), un desarrollador salvadore√±o, en un charla de [Caf√© Digital](https://twitter.com/cafedigitalsv) y as√≠ salir de mi zona de comfort. Cre√©me cuando te digo que me divert√≠.\n\n\n# Referencias\n\n- [Building a blog with Svelte, Sapper, and Markdown](https://www.mahmoudashraf.dev/blog/build-a-blog-with-svelte-and-markdown/) \n- [Sapper docs](https://sapper.svelte.dev/docs#How_it_works)\n- [Static Svelte: JavaScript Blogging with 93% less JavaScript](https://www.swyx.io/writing/svelte-static/)\n- [Markdown](https://es.wikipedia.org/wiki/Markdown)"}]